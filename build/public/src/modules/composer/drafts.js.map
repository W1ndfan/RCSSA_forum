{"version":3,"sources":["node_modules/nodebb-plugin-composer-default/static/lib/composer/drafts.js"],"names":["define","drafts","saveThrottleId","saving","init","postContainer","postData","draftIconEl","find","on","resetTimeout","setTimeout","saveDraft","$","this","toggleClass","window","e","open","localStorage","getItem","JSON","parse","console","warn","length","forEach","save_id","updateVisibility","migrateGuest","clearTimeout","getDraft","get","uid","split","parseInt","title","text","handle","sessionStorage","canSave","app","user","val","raw","storage","setItem","removeDraft","removeItem","set","add","idx","indexOf","push","splice","stringify","test","keys","Object","filter","key","migrated","Set","renamed","map","parts","slice","join","loadOpen","available","require","composer","saveObj","type","id","content","newTopic","cid","body","tags","socket","emit","err","topicObj","newReply","undefined","editPost","x","DOMException","code","name"],"mappings":"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","file":"node_modules/nodebb-plugin-composer-default/static/lib/composer/drafts.js","sourcesContent":["'use strict';\n\n/* globals define */\n\ndefine('composer/drafts', function () {\n\n\tvar drafts = {};\n\tvar\tsaveThrottleId;\n\tvar saving = false;\n\n\tdrafts.init = function(postContainer, postData) {\n\t\tvar draftIconEl = postContainer.find('.draft-icon');\n\n\t\tpostContainer.on('keyup', 'textarea, input.handle, input.title', function() {\n\t\t\tresetTimeout();\n\n\t\t\tsaveThrottleId = setTimeout(function() {\n\t\t\t\tsaveDraft(postContainer, draftIconEl, postData);\n\t\t\t}, 1000);\n\t\t});\n\n\t\tdraftIconEl.on('animationend', function () {\n\t\t\t$(this).toggleClass('active', false);\n\t\t});\n\n\t\t$(window).on('unload', function (e) {\n\t\t\t// Update visibility on all open composers\n\t\t\ttry {\n\t\t\t\tvar open = localStorage.getItem('drafts:open');\n\t\t\t\topen = JSON.parse(open) || [];\n\t\t\t} catch (e) {\n\t\t\t\tconsole.warn('[composer/drafts] Could not read list of open/available drafts');\n\t\t\t\topen = [];\n\t\t\t}\n\t\t\tif (open.length) {\n\t\t\t\topen.forEach(function (save_id) {\n\t\t\t\t\tdrafts.updateVisibility('open', save_id);\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\tdrafts.migrateGuest();\n\t};\n\n\tfunction resetTimeout() {\n\t\tif (saveThrottleId) {\n\t\t\tclearTimeout(saveThrottleId);\n\t\t\tsaveThrottleId = 0;\n\t\t}\n\t}\n\n\t// deprecated, for removal v1.14.x\n\tdrafts.getDraft = function(save_id) {\n\t\tconsole.warn('[composer/drafts] drafts.getDraft is deprecated! Use drafts.get() instead.');\n\t\treturn localStorage.getItem(save_id);\n\t};\n\n\tdrafts.get = function(save_id) {\n\t\tconst uid = save_id.split(':')[1];\n\n\t\tif (parseInt(uid, 10)) {\n\t\t\treturn {\n\t\t\t\ttitle: localStorage.getItem(save_id + ':title'),\n\t\t\t\ttext: localStorage.getItem(save_id),\n\t\t\t}\n\t\t} else {\n\t\t\treturn {\n\t\t\t\thandle: sessionStorage.getItem(save_id + ':handle'),\n\t\t\t\ttitle: sessionStorage.getItem(save_id + ':title'),\n\t\t\t\ttext: sessionStorage.getItem(save_id),\n\t\t\t}\n\t\t}\n\t}\n\n\tfunction saveDraft(postContainer, draftIconEl, postData) {\n\t\tif (canSave(app.user.uid ? 'localStorage' : 'sessionStorage') && postData && postData.save_id && postContainer.length) {\n\t\t\tvar title = postContainer.find('input.title').val();\n\t\t\tvar raw = postContainer.find('textarea').val();\n\t\t\tvar storage = app.user.uid ? localStorage : sessionStorage;\n\n\t\t\tif (raw.length) {\n\t\t\t\tstorage.setItem(postData.save_id, raw);\n\t\t\t\tstorage.setItem(postData.save_id + ':title', title);\n\t\t\t\tif (!app.user.uid) {\n\t\t\t\t\tvar handle = postContainer.find('input.handle').val();\n\t\t\t\t\tstorage.setItem(postData.save_id + ':handle', handle);\n\t\t\t\t}\n\t\t\t\tdraftIconEl.toggleClass('active', true);\n\t\t\t} else {\n\t\t\t\tdrafts.removeDraft(postData.save_id);\n\t\t\t}\n\t\t}\n\t}\n\n\tdrafts.removeDraft = function(save_id) {\n\t\tif (!save_id) {\n\t\t\treturn;\n\t\t}\n\t\tresetTimeout();\n\t\t// Remove save_id from list of open and available drafts\n\t\tdrafts.updateVisibility('available', save_id);\n\t\tdrafts.updateVisibility('open', save_id);\n\n\t\tlocalStorage.removeItem(save_id);\n\t\tlocalStorage.removeItem(save_id + ':title');\n\t\treturn;\n\t};\n\n\tdrafts.updateVisibility = function (set, save_id, add) {\n\t\tif (!canSave(app.user.uid ? 'localStorage' : 'sessionStorage') || !save_id) {\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tvar open = localStorage.getItem('drafts:' + set);\n\t\t\topen = open ? JSON.parse(open) : [];\n\t\t} catch (e) {\n\t\t\tconsole.warn('[composer/drafts] Could not read list of open drafts');\n\t\t\tvar open = [];\n\t\t}\n\t\tvar idx = open.indexOf(save_id);\n\n\t\tif (add && idx === -1) {\n\t\t\topen.push(save_id);\n\t\t} else if (!add && idx !== -1) {\n\t\t\topen.splice(idx, 1);\n\t\t}\t// otherwise do nothing\n\n\t\tlocalStorage.setItem('drafts:' + set, JSON.stringify(open));\n\t};\n\n\tdrafts.migrateGuest = function () {\n\t\t// If any drafts are made while as guest, and user then logs in, assume control of those drafts\n\t\tif (canSave('localStorage') && app.user.uid) {\n\t\t\tvar test = /^composer:\\d+:\\w+:\\d+(:\\w+)?$/;\n\t\t\tvar keys = Object.keys(sessionStorage).filter(function (key) {\n\t\t\t\treturn test.test(key);\n\t\t\t});\n\t\t\tvar migrated = new Set([]);\n\t\t\tvar renamed = keys.map(function (key) {\n\t\t\t\tvar parts = key.split(':');\n\t\t\t\tparts[1] = app.user.uid;\n\n\t\t\t\tmigrated.add(parts.slice(0, 4).join(':'));\n\t\t\t\treturn parts.join(':');\n\t\t\t});\n\n\t\t\tkeys.forEach(function (key, idx) {\n\t\t\t\tlocalStorage.setItem(renamed[idx], sessionStorage.getItem(key));\n\t\t\t\tsessionStorage.removeItem(key);\n\t\t\t});\n\n\t\t\tmigrated.forEach(function(save_id) {\n\t\t\t\tdrafts.updateVisibility('available', save_id, 1);\n\t\t\t});\n\n\t\t\treturn migrated;\n\t\t}\n\t}\n\n\tdrafts.loadOpen = function () {\n\t\t// Load drafts if they were open\n\t\ttry {\n\t\t\tvar available = localStorage.getItem('drafts:available');\n\t\t\tvar open = localStorage.getItem('drafts:open');\n\t\t\tavailable = JSON.parse(available) || [];\n\t\t\topen = JSON.parse(open) || [];\n\t\t} catch (e) {\n\t\t\tconsole.warn('[composer/drafts] Could not read list of open/available drafts');\n\t\t\tavailable = [];\n\t\t\topen = [];\n\t\t}\n\n\t\tif (available.length && app.user && app.user.uid !== 0) {\n\t\t\trequire(['composer'], function (composer) {\n\t\t\t\t// Deconstruct each save_id and open up composer\n\t\t\t\tavailable.forEach(function (save_id) {\n\t\t\t\t\tif (!save_id) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tvar saveObj = save_id.split(':');\n\t\t\t\t\tvar uid = saveObj[1];\n\t\t\t\t\tvar type = saveObj[2];\n\t\t\t\t\tvar id = saveObj[3];\n\t\t\t\t\tvar content = drafts.get(save_id);\n\n\t\t\t\t\t// If draft is already open, do nothing\n\t\t\t\t\tif (open.indexOf(save_id) !== -1) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Don't open other peoples' drafts\n\t\t\t\t\tif (parseInt(app.user.uid, 10) !== parseInt(uid, 10)) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!content || (content.text && content.title && !content.text.title && !content.text.length)) {\n\t\t\t\t\t\t// Empty content, remove from list of open drafts\n\t\t\t\t\t\tdrafts.updateVisibility('available', save_id);\n\t\t\t\t\t\tdrafts.updateVisibility('open', save_id);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (type === 'cid') {\n\t\t\t\t\t\tcomposer.newTopic({\n\t\t\t\t\t\t\tcid: id,\n\t\t\t\t\t\t\ttitle: content.title,\n\t\t\t\t\t\t\tbody: content.text,\n\t\t\t\t\t\t\ttags: [],\n\t\t\t\t\t\t});\n\t\t\t\t\t} else if (type === 'tid') {\n\t\t\t\t\t\tsocket.emit('topics.getTopic', id, function (err, topicObj) {\n\t\t\t\t\t\t\tcomposer.newReply(id, undefined, topicObj.title, content.text);\n\t\t\t\t\t\t});\n\t\t\t\t\t} else if (type === 'pid') {\n\t\t\t\t\t\tcomposer.editPost(id);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t}\n\n\t// Feature detection courtesy of: https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API/Using_the_Web_Storage_API\n\tfunction canSave(type) {\n\t\tvar storage;\n\t\ttry {\n\t\t\tstorage = window[type];\n\t\t\tvar x = '__storage_test__';\n\t\t\tstorage.setItem(x, x);\n\t\t\tstorage.removeItem(x);\n\t\t\treturn true;\n\t\t}\n\t\tcatch(e) {\n\t\t\treturn e instanceof DOMException && (\n\t\t\t\t// everything except Firefox\n\t\t\t\te.code === 22 ||\n\t\t\t\t// Firefox\n\t\t\t\te.code === 1014 ||\n\t\t\t\t// test name field too, because code might not be present\n\t\t\t\t// everything except Firefox\n\t\t\t\te.name === 'QuotaExceededError' ||\n\t\t\t\t// Firefox\n\t\t\t\te.name === 'NS_ERROR_DOM_QUOTA_REACHED') &&\n\t\t\t\t// acknowledge QuotaExceededError only if there's something already stored\n\t\t\t\t(storage && storage.length !== 0);\n\t\t}\n\t}\n\n\treturn drafts;\n});"]}